{% extends 'includes/base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-2">
        <div class="col-12">
            <div class="card">
                <div class="card-header p-2">
                    <div class="row">
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <img src="{{ url_for('static', filename='images/logo_MM.png') }}" alt="Logo" class="img-fluid me-2" style="max-height: 60px; object-fit: contain;">
                                <div class="company-info small">
                                    <p class="mb-0"><strong>MIMOUN MARKET SL</strong></p>
                                    <p class="mb-0">CIF: B95829370</p>
                                    <p class="mb-0">Polígono Artunduaga 4, Pab 3</p>
                                    <p class="mb-0">48970 Basauri (Bizkaia)</p>
                                    <p class="mb-0">Tel: 681392805</p>
                                    <p class="mb-0">Email: info@mimounmarket.com</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div id="transportista-info" class="text-end small">
                                <!-- Aquí se cargarán los datos del transportista -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-2">
                    <h5 class="text-center mb-2">ALBARÁN DE SALIDA MERCANCÍA</h5>
    <form method="post" id="cabecera-form">
                        <div class="row g-2 mb-2">
                            <div class="col-md-2">
                                <label class="form-label small mb-0">Ruta</label>
                                <select name="ruta_id" id="ruta_id" class="form-select form-select-sm" required>
                    <option value="">Seleccione una ruta</option>
                                    {% for ruta in rutas %}
                                        <option value="{{ ruta.id }}" data-porcentaje="{{ ruta.porcentaje_default }}">
                                            {{ ruta.nombre }}
                                        </option>
                    {% endfor %}
                </select>
            </div>
                            <div class="col-md-3">
                                <label class="form-label small mb-0">Transportista</label>
                                <select name="transportista_id" id="transportista_id" class="form-select form-select-sm" required>
                    <option value="">Seleccione un transportista</option>
                                    {% for t in transportistas %}
                                        <option value="{{ t.id }}" data-telefono="{{ t.telefono }}">
                                            {{ t.nombre }}
                                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                                <label class="form-label small mb-0">Fecha</label>
                                <input type="date" name="fecha" class="form-control form-control-sm" value="{{ fecha_hoy }}" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small mb-0">N° Albarán</label>
                                <input type="text" name="numero_albaran" id="numero_albaran" 
                                       class="form-control form-control-sm" readonly 
                                       value="{{ siguiente_numero }}">
            </div>
            <div class="col-md-2">
                                <label class="form-label small mb-0">% Pactado</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" step="0.01" min="0" max="100" 
                                           name="porcentaje_pactado" id="porcentaje_pactado" 
                                           class="form-control form-control-sm" required>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary btn-sm" id="btn-guardar">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Tabla de líneas (inicialmente oculta) -->
                    <div id="lineas-albaran" class="mt-2" style="display: none;">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>BENEFICIO</th>
                                    <th>IMP. LIQU</th>
                                    <th>%</th>
                                    <th>AYAD MOHAMED</th>
                                </tr>
                            </thead>
                            <tbody id="lineas-body">
                                <!-- Aquí se cargarán las líneas dinámicamente -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td class="text-end"><strong id="total-beneficio">0.00 €</strong></td>
                                    <td class="text-end"><strong id="total-imp-liqu">0.00 €</strong></td>
                                    <td class="text-end"><strong id="porcentaje-promedio">0.00%</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Sección de Líneas de Albarán -->
                    <div id="lineas-form" class="mt-4">
                        <h4>Líneas de Albarán</h4>
                        
                        <!-- Tabla de líneas -->
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Serie</th>
                                        <th>Número</th>
                                        <th>Cliente</th>
                                        <th>Código</th>
                                        <th>Municipio</th>
                                        <th>Importe</th>
                                        <th>Beneficio</th>
                                        <th>Imp. Líquido</th>
                                        <th>%</th>
                                        <th>Conductor</th>
                                        <th>TLPA</th>
                                        <th>Ben. Post</th>
                                        <th>% Ben. Real</th>
                                        <th>Deuda</th>
                                        <th>Líneas</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="lineas-body">
                                    <!-- Template para nueva línea -->
                                    <template id="linea-template">
                                        <tr class="linea-albaran">
                                            <td><span class="fecha-alb"></span></td>
                                            <td><input type="text" class="form-control form-control-sm serie-alb" maxlength="10"></td>
                                            <td><input type="text" class="form-control form-control-sm numero-alb" maxlength="20"></td>
                                            <td><span class="nombre-cliente"></span></td>
                                            <td><span class="cod-cliente"></span></td>
                                            <td><span class="municipio-envio"></span></td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm importe" step="0.01" readonly>
                                                <button class="btn btn-sm btn-outline-warning edit-importe" title="Editar importe">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </td>
                                            <td><span class="beneficio"></span></td>
                                            <td><span class="imp-liqu"></span></td>
                                            <td><span class="porcentaje"></span></td>
                                            <td><span class="conductor"></span></td>
                                            <td><span class="tlpa"></span></td>
                                            <td><span class="ben-post-log"></span></td>
                                            <td><span class="por-ben-real"></span></td>
                                            <td><span class="deuda"></span></td>
                                            <td><span class="lineas"></span></td>
                                            <td>
                                                <button class="btn btn-sm btn-success btn-ok" disabled title="Finalizar línea">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-sm btn-primary btn-mas" disabled title="Finalizar y agregar nueva línea">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Modal de confirmación para editar importe -->
                    <div class="modal fade" id="editImporteModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Confirmar modificación</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>¿Está seguro de modificar el importe? Esta acción recalculará los siguientes campos:</p>
                                    <ul>
                                        <li>TLPA (Tarifa Logística Pactada)</li>
                                        <li>Beneficio Post-Logístico</li>
                                        <li>Porcentaje Beneficio Real</li>
                                    </ul>
                                    <div class="form-group">
                                        <label for="nuevoImporte">Nuevo importe:</label>
                                        <input type="number" class="form-control" id="nuevoImporte" step="0.01">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="button" class="btn btn-primary" id="confirmarImporte">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección de firmas -->
                    <div class="row mt-3">
                        <div class="col-6">
                            <p class="small mb-1">ENTREGA MIMOUN MARKET SL</p>
                            <div class="border-bottom" style="height: 60px;"></div>
                        </div>
                        <div class="col-6">
                            <p class="small mb-1">RECIBE</p>
                            <div class="border-bottom" style="height: 60px;"></div>
                        </div>
                    </div>

                    <!-- Sección de revisión -->
                    <div class="row mt-2">
                        <div class="col-6">
                            <p class="small mb-1">REVISÓ MERCANCÍA</p>
                            <div class="border-bottom" style="height: 30px;"></div>
                        </div>
                        <div class="col-6">
                            <p class="small mb-1">CONDUCTOR</p>
                            <div id="conductor-nombre" class="small"></div>
                        </div>
                    </div>

                    <!-- Cláusula de aceptación -->
                    <div class="row mt-2">
                        <div class="col-12">
                            <p class="small mb-0" style="font-size: 0.7rem;">
                                <strong>Cláusula de Aceptación y Responsabilidad:</strong> Al firmar el presente albarán de salida, la persona receptora confirma que los importes detallados en este documento
                                han sido revisados y aceptados, y que la mercancía recibida se encuentra en perfecto estado. A partir de este momento, la responsabilidad sobre el estado de la
                                mercancía, incluyendo cualquier daño, pérdida de frío o deterioro en la calidad de los productos, recae sobre la empresa logística encargada del transporte. La
                                empresa proveedora logística asumirá la totalidad de los costos y responsabilidades derivados de cualquier incidencia que afecte a la mercancía desde la firma de
                                este documento.
                            </p>
            </div>
        </div>
            </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const rutaSelect = document.getElementById('ruta_id');
    const transportistaSelect = document.getElementById('transportista_id');
    const porcentajeInput = document.getElementById('porcentaje_pactado');
    const transportistaInfo = document.getElementById('transportista-info');
    const numeroAlbaranInput = document.getElementById('numero_albaran');
    const conductorNombre = document.getElementById('conductor-nombre');
    const form = document.getElementById('cabecera-form');

    // Obtener número de albarán al cargar
    async function obtenerNumeroAlbaran() {
        try {
            const response = await fetch('/albaranes/api/siguiente_numero');
            if (!response.ok) {
                throw new Error('Error al obtener número de albarán');
            }
            const data = await response.json();
            if (data.numero) {
                numeroAlbaranInput.value = data.numero;
            } else {
                throw new Error('No se pudo obtener el número de albarán');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al obtener número de albarán: ' + error.message);
        }
    }

    // Cargar número de albarán al iniciar
    obtenerNumeroAlbaran();

    // Actualizar porcentaje cuando cambia la ruta
    rutaSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const porcentaje = selectedOption.dataset.porcentaje;
        if (porcentaje) {
            porcentajeInput.value = porcentaje;
        }
        actualizarConductor();
    });

    // Función para actualizar el conductor
    function actualizarConductor() {
        if (transportistaSelect.value && rutaSelect.value) {
            const nombreTransportista = transportistaSelect.options[transportistaSelect.selectedIndex].text;
            const rutaSeleccionada = rutaSelect.options[rutaSelect.selectedIndex].text;
            conductorNombre.innerHTML = `<strong>${nombreTransportista}</strong><br>RUTA ${rutaSeleccionada}`;
        }
    }

    // Cargar datos del transportista
    transportistaSelect.addEventListener('change', async function() {
        const transportistaId = this.value;
        if (!transportistaId) {
            transportistaInfo.innerHTML = '';
            conductorNombre.innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`/albaranes/api/transportista/${transportistaId}`);
            if (!response.ok) throw new Error('Error al cargar datos del transportista');
            const data = await response.json();
            
            transportistaInfo.innerHTML = `
                <p class="mb-0">CIF: ${data.documento_cif}</p>
                <p class="mb-0">${data.direccion}</p>
                <p class="mb-0">${data.codigo_postal}</p>
                <p class="mb-0">${data.provincia}</p>
                <p class="mb-0">Tel: ${data.telefono}</p>
                <p class="mb-0">Email: ${data.email}</p>
            `;

            actualizarConductor();
        } catch (error) {
            console.error('Error:', error);
            transportistaInfo.innerHTML = '<p class="text-danger mb-0">Error al cargar datos del transportista</p>';
            conductorNombre.innerHTML = '';
        }
    });

    // Validar porcentaje
    porcentajeInput.addEventListener('input', function() {
        const valor = parseFloat(this.value);
        if (valor < 0) this.value = 0;
        if (valor > 100) this.value = 100;
    });

    // Función para cargar las líneas de la ruta
    async function cargarLineasRuta(rutaId, albaranId, porcentajePactado) {
        try {
            const response = await fetch(`/albaranes/api/lineas_ruta/${rutaId}`);
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Error al cargar líneas de la ruta');
            }
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message);
            }
            
            const lineas = result.data;
            const tbody = document.getElementById('lineas-body');
            tbody.innerHTML = '';
            
            let totalBeneficio = 0;
            let totalImpLiqu = 0;
            
            lineas.forEach(linea => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-end">${parseFloat(linea.beneficio).toFixed(2)} €</td>
                    <td class="text-end">${parseFloat(linea.imp_liqu).toFixed(2)} €</td>
                    <td class="text-end">${parseFloat(linea.porcentaje).toFixed(2)}%</td>
                    <td>${linea.conductor}</td>
                `;
                tbody.appendChild(tr);
                
                totalBeneficio += parseFloat(linea.beneficio);
                totalImpLiqu += parseFloat(linea.imp_liqu);
            });
            
            // Actualizar totales
            document.getElementById('total-beneficio').textContent = totalBeneficio.toFixed(2) + ' €';
            document.getElementById('total-imp-liqu').textContent = totalImpLiqu.toFixed(2) + ' €';
            document.getElementById('porcentaje-promedio').textContent = porcentajePactado + '%';
            
            // Mostrar la tabla de líneas
            document.getElementById('lineas-albaran').style.display = 'block';
            
            // Deshabilitar el formulario de cabecera
            document.querySelectorAll('#cabecera-form select, #cabecera-form input').forEach(el => {
                el.disabled = true;
            });
            document.getElementById('btn-guardar').style.display = 'none';
            
        } catch (error) {
            console.error('Error:', error);
            alert(error.message || 'Error al cargar las líneas de la ruta');
        }
    }

    // Modificar el manejador del formulario
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        try {
            const formData = new FormData(this);
            const response = await fetch('/albaranes/nuevo', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) throw new Error('Error en la respuesta del servidor');
            
            const result = await response.json();
            if (result.success) {
                // Mostrar mensaje de éxito
                alert(result.message);
                
                // Cargar las líneas de la ruta
                cargarLineasRuta(result.ruta_id, result.albaran_id, result.porcentaje_pactado);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al guardar el albarán: ' + error.message);
        }
    });
});

// Cache para los resultados de la consulta SQL
let albaranesCache = new Map();

// Función para agregar nueva línea
function agregarNuevaLinea() {
    const template = document.getElementById('linea-template');
    const nuevaLinea = template.content.cloneNode(true);
    document.getElementById('lineas-body').appendChild(nuevaLinea);
    
    // Configurar eventos para la nueva línea
    const ultimaLinea = document.querySelector('#lineas-body tr:last-child');
    configurarEventosLinea(ultimaLinea);
}

// Función para configurar eventos de una línea
function configurarEventosLinea(lineaElement) {
    const serieInput = lineaElement.querySelector('.serie-alb');
    const numeroInput = lineaElement.querySelector('.numero-alb');
    const importeInput = lineaElement.querySelector('.importe');
    const editImporteBtn = lineaElement.querySelector('.edit-importe');
    const btnOk = lineaElement.querySelector('.btn-ok');
    const btnMas = lineaElement.querySelector('.btn-mas');

    // Evento para buscar albarán al presionar Enter en numero-alb
    numeroInput.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
            const serie = serieInput.value.trim();
            const numero = numeroInput.value.trim();
            
            if (serie && numero) {
                await buscarYRellenarDatos(serie, numero, lineaElement);
            }
        }
    });

    // Evento para el botón de editar importe
    editImporteBtn.addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('editImporteModal'));
        const importeActual = importeInput.value;
        document.getElementById('nuevoImporte').value = importeActual;
        
        // Configurar evento del botón confirmar
        document.getElementById('confirmarImporte').onclick = () => {
            const nuevoImporte = document.getElementById('nuevoImporte').value;
            importeInput.value = nuevoImporte;
            recalcularCampos(lineaElement);
            modal.hide();
        };
        
        modal.show();
    });

    // Eventos para los botones OK y Más
    btnOk.addEventListener('click', () => finalizarLinea(lineaElement, false));
    btnMas.addEventListener('click', () => finalizarLinea(lineaElement, true));
}

// Función para buscar y rellenar datos
async function buscarYRellenarDatos(serie, numero, lineaElement) {
    try {
        const cacheKey = `${serie}-${numero}`;
        let datos;

        if (albaranesCache.has(cacheKey)) {
            datos = albaranesCache.get(cacheKey);
        } else {
            const response = await fetch(`/albaranes/api/buscar_albaran/${serie}/${numero}`);
            if (!response.ok) throw new Error('No se encontró el albarán');
            datos = await response.json();
            albaranesCache.set(cacheKey, datos);
        }

        rellenarDatosLinea(lineaElement, datos);
    } catch (error) {
        alert(error.message);
    }
}

// Función para rellenar datos en la línea
function rellenarDatosLinea(lineaElement, datos) {
    // Rellenar campos con los datos
    lineaElement.querySelector('.fecha-alb').textContent = datos.fecha_alb;
    lineaElement.querySelector('.nombre-cliente').textContent = datos.nombre_cliente;
    lineaElement.querySelector('.cod-cliente').textContent = datos.cod_cliente;
    lineaElement.querySelector('.municipio-envio').textContent = datos.municipio_envio;
    lineaElement.querySelector('.importe').value = datos.importe;
    lineaElement.querySelector('.beneficio').textContent = datos.beneficio;
    lineaElement.querySelector('.imp-liqu').textContent = datos.imp_liqu;
    lineaElement.querySelector('.porcentaje').textContent = datos.porcentaje;
    lineaElement.querySelector('.conductor').textContent = datos.conductor;
    lineaElement.querySelector('.deuda').textContent = datos.deuda;
    lineaElement.querySelector('.lineas').textContent = datos.lineas;

    // Calcular campos derivados
    recalcularCampos(lineaElement);

    // Habilitar botones
    lineaElement.querySelector('.btn-ok').disabled = false;
    lineaElement.querySelector('.btn-mas').disabled = false;
}

// Función para recalcular campos
function recalcularCampos(lineaElement) {
    const importe = parseFloat(lineaElement.querySelector('.importe').value) || 0;
    const porcentajePactado = parseFloat(document.getElementById('porcentaje-pactado').value) || 0;
    
    // Calcular TLPA
    const tlpa = importe * (porcentajePactado / 100);
    lineaElement.querySelector('.tlpa').textContent = tlpa.toFixed(2);
    
    // Calcular Beneficio Post-Logístico
    const beneficio = parseFloat(lineaElement.querySelector('.beneficio').textContent) || 0;
    const benPostLog = beneficio - tlpa;
    lineaElement.querySelector('.ben-post-log').textContent = benPostLog.toFixed(2);
    
    // Calcular Porcentaje Beneficio Real
    const porBenReal = importe !== 0 ? (benPostLog / importe) * 100 : 0;
    lineaElement.querySelector('.por-ben-real').textContent = porBenReal.toFixed(2);
}

// Función para finalizar línea
function finalizarLinea(lineaElement, agregarNueva) {
    // Deshabilitar inputs
    lineaElement.querySelectorAll('input').forEach(input => input.readOnly = true);
    lineaElement.querySelectorAll('button').forEach(btn => btn.disabled = true);
    
    // Actualizar totales de la cabecera
    actualizarTotalesCabecera();
    
    if (agregarNueva) {
        agregarNuevaLinea();
    }
}

// Función para actualizar totales de la cabecera
function actualizarTotalesCabecera() {
    let totalBeneficio = 0;
    let totalImpLiqu = 0;
    let totalTLPA = 0;
    
    document.querySelectorAll('.linea-albaran').forEach(linea => {
        totalBeneficio += parseFloat(linea.querySelector('.beneficio').textContent) || 0;
        totalImpLiqu += parseFloat(linea.querySelector('.imp-liqu').textContent) || 0;
        totalTLPA += parseFloat(linea.querySelector('.tlpa').textContent) || 0;
    });
    
    // Actualizar totales en la cabecera
    document.getElementById('total-beneficio').textContent = totalBeneficio.toFixed(2);
    document.getElementById('total-imp-liqu').textContent = totalImpLiqu.toFixed(2);
    document.getElementById('total-tlpa').textContent = totalTLPA.toFixed(2);
}

// Inicializar primera línea al cargar
document.addEventListener('DOMContentLoaded', () => {
    agregarNuevaLinea();
});
</script>
{% endblock %}
