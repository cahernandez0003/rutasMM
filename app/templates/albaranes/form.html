{% extends 'includes/base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-2">
        <div class="col-12">
            <div class="card">
                <div class="card-header p-2">
                    <div class="row">
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <img src="{{ url_for('static', filename='images/logo_MM.png') }}" alt="Logo" class="img-fluid me-2" style="max-height: 60px; object-fit: contain;">
                                <div class="company-info small">
                                    <p class="mb-0"><strong>MIMOUN MARKET SL</strong></p>
                                    <p class="mb-0">CIF: B95829370</p>
                                    <p class="mb-0">Polígono Artunduaga 4, Pab 3</p>
                                    <p class="mb-0">48970 Basauri (Bizkaia)</p>
                                    <p class="mb-0">Tel: 681392805</p>
                                    <p class="mb-0">Email: info@mimounmarket.com</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div id="transportista-info" class="text-end small">
                                <!-- Aquí se cargarán los datos del transportista -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-2">
                    <h5 class="text-center mb-2">ALBARÁN DE SALIDA MERCANCÍA</h5>
    <form method="post" id="cabecera-form">
                        <div class="row g-2 mb-2">
                            <div class="col-md-2">
                                <label class="form-label small mb-0">Ruta</label>
                                <select name="ruta_id" id="ruta_id" class="form-select form-select-sm" required>
                    <option value="">Seleccione una ruta</option>
                                    {% for ruta in rutas %}
                                        <option value="{{ ruta.id }}" data-porcentaje="{{ ruta.porcentaje_default }}">
                                            {{ ruta.nombre }}
                                        </option>
                    {% endfor %}
                </select>
            </div>
                            <div class="col-md-3">
                                <label class="form-label small mb-0">Transportista</label>
                                <select name="transportista_id" id="transportista_id" class="form-select form-select-sm" required>
                    <option value="">Seleccione un transportista</option>
                                    {% for t in transportistas %}
                                        <option value="{{ t.id }}" data-telefono="{{ t.telefono }}">
                                            {{ t.nombre }}
                                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                                <label class="form-label small mb-0">Fecha</label>
                                <input type="date" name="fecha" class="form-control form-control-sm" value="{{ fecha_hoy }}" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small mb-0">N° Albarán</label>
                                <input type="text" name="numero_albaran" id="numero_albaran" 
                                       class="form-control form-control-sm" readonly 
                                       value="{{ siguiente_numero }}">
            </div>
            <div class="col-md-2">
                                <label class="form-label small mb-0">% Pactado</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" step="0.01" min="0" max="100" 
                                           name="porcentaje_pactado" id="porcentaje_pactado" 
                                           class="form-control form-control-sm" required>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary btn-sm" id="btn-guardar">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Tabla de líneas (inicialmente oculta) -->
                    <div id="lineas-albaran" class="mt-2" style="display: none;">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>BENEFICIO</th>
                                    <th>IMP. LIQU</th>
                                    <th>%</th>
                                    <th>AYAD MOHAMED</th>
                                </tr>
                            </thead>
                            <tbody id="lineas-resumen">
                                <!-- Aquí se cargarán las líneas de resumen dinámicamente -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td class="text-end"><strong id="total-beneficio">0.00 €</strong></td>
                                    <td class="text-end"><strong id="total-imp-liqu">0.00 €</strong></td>
                                    <td class="text-end"><strong id="porcentaje-promedio">0.00%</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Sección de Líneas de Albarán (inicialmente oculta) -->
                    <div id="lineas-form" class="mt-4" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4>Líneas de Albarán</h4>
                            <button type="button" class="btn btn-primary btn-sm" id="btn-agregar-linea">
                                <i class="fas fa-plus"></i> Agregar Línea
                            </button>
                        </div>
                        
                        <!-- Tabla de líneas -->
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Serie</th>
                                        <th>Número</th>
                                        <th>Cliente</th>
                                        <th>Código</th>
                                        <th>Municipio</th>
                                        <th>Importe</th>
                                        <th>Beneficio</th>
                                        <th>Imp. Líquido</th>
                                        <th>%</th>
                                        <th>Conductor</th>
                                        <th>TLPA</th>
                                        <th>Ben. Post</th>
                                        <th>% Ben. Real</th>
                                        <th>Deuda</th>
                                        <th>Líneas</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="lineas-body">
                                    <!-- Template para nueva línea -->
                                    <template id="linea-template">
                                        <tr class="linea-albaran">
                                            <td><span class="fecha-alb"></span></td>
                                            <td><input type="text" class="form-control form-control-sm serie-alb" maxlength="10"></td>
                                            <td><input type="text" class="form-control form-control-sm numero-alb" maxlength="20"></td>
                                            <td><span class="nombre-cliente"></span></td>
                                            <td><span class="cod-cliente"></span></td>
                                            <td><span class="municipio-envio"></span></td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm importe" step="0.01" readonly>
                                                <button class="btn btn-sm btn-outline-warning edit-importe" title="Editar importe">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </td>
                                            <td><span class="beneficio"></span></td>
                                            <td><span class="imp-liqu"></span></td>
                                            <td><span class="porcentaje"></span></td>
                                            <td><span class="conductor"></span></td>
                                            <td><span class="tlpa"></span></td>
                                            <td><span class="ben-post-log"></span></td>
                                            <td><span class="por-ben-real"></span></td>
                                            <td><span class="deuda"></span></td>
                                            <td><span class="lineas"></span></td>
                                            <td>
                                                <button class="btn btn-sm btn-success btn-ok" disabled title="Finalizar línea">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-sm btn-primary btn-mas" disabled title="Finalizar y agregar nueva línea">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger btn-eliminar" title="Eliminar línea">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Modal de confirmación para editar importe -->
                    <div class="modal fade" id="editImporteModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Confirmar modificación</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>¿Está seguro de modificar el importe? Esta acción recalculará los siguientes campos:</p>
                                    <ul>
                                        <li>TLPA (Tarifa Logística Pactada)</li>
                                        <li>Beneficio Post-Logístico</li>
                                        <li>Porcentaje Beneficio Real</li>
                                    </ul>
                                    <div class="form-group">
                                        <label for="nuevoImporte">Nuevo importe:</label>
                                        <input type="number" class="form-control" id="nuevoImporte" step="0.01">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="button" class="btn btn-primary" id="confirmarImporte">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección de firmas -->
                    <div class="row mt-3">
                        <div class="col-6">
                            <p class="small mb-1">ENTREGA MIMOUN MARKET SL</p>
                            <div class="border-bottom" style="height: 60px;"></div>
                        </div>
                        <div class="col-6">
                            <p class="small mb-1">RECIBE</p>
                            <div class="border-bottom" style="height: 60px;"></div>
                        </div>
                    </div>

                    <!-- Sección de revisión -->
                    <div class="row mt-2">
                        <div class="col-6">
                            <p class="small mb-1">REVISÓ MERCANCÍA</p>
                            <div class="border-bottom" style="height: 30px;"></div>
                        </div>
                        <div class="col-6">
                            <p class="small mb-1">CONDUCTOR</p>
                            <div id="conductor-nombre" class="small"></div>
                        </div>
                    </div>

                    <!-- Cláusula de aceptación -->
                    <div class="row mt-2">
                        <div class="col-12">
                            <p class="small mb-0" style="font-size: 0.7rem;">
                                <strong>Cláusula de Aceptación y Responsabilidad:</strong> Al firmar el presente albarán de salida, la persona receptora confirma que los importes detallados en este documento
                                han sido revisados y aceptados, y que la mercancía recibida se encuentra en perfecto estado. A partir de este momento, la responsabilidad sobre el estado de la
                                mercancía, incluyendo cualquier daño, pérdida de frío o deterioro en la calidad de los productos, recae sobre la empresa logística encargada del transporte. La
                                empresa proveedora logística asumirá la totalidad de los costos y responsabilidades derivados de cualquier incidencia que afecte a la mercancía desde la firma de
                                este documento.
                            </p>
            </div>
        </div>
            </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const rutaSelect = document.getElementById('ruta_id');
    const transportistaSelect = document.getElementById('transportista_id');
    const porcentajeInput = document.getElementById('porcentaje_pactado');
    const transportistaInfo = document.getElementById('transportista-info');
    const numeroAlbaranInput = document.getElementById('numero_albaran');
    const conductorNombre = document.getElementById('conductor-nombre');
    const form = document.getElementById('cabecera-form');

    // Obtener número de albarán al cargar
    async function obtenerNumeroAlbaran() {
        try {
            const response = await fetch('/albaranes/api/siguiente_numero');
            if (!response.ok) {
                throw new Error('Error al obtener número de albarán');
            }
            const data = await response.json();
            if (data.numero) {
                numeroAlbaranInput.value = data.numero;
            } else {
                throw new Error('No se pudo obtener el número de albarán');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al obtener número de albarán: ' + error.message);
        }
    }

    // Cargar número de albarán al iniciar
    obtenerNumeroAlbaran();

    // Actualizar porcentaje cuando cambia la ruta
    rutaSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const porcentaje = selectedOption.dataset.porcentaje;
        if (porcentaje) {
            porcentajeInput.value = porcentaje;
        }
        actualizarConductor();
    });

    // Función para actualizar el conductor
    function actualizarConductor() {
        if (transportistaSelect.value && rutaSelect.value) {
            const nombreTransportista = transportistaSelect.options[transportistaSelect.selectedIndex].text;
            const rutaSeleccionada = rutaSelect.options[rutaSelect.selectedIndex].text;
            conductorNombre.innerHTML = `<strong>${nombreTransportista}</strong><br>RUTA ${rutaSeleccionada}`;
        }
    }

    // Cargar datos del transportista
    transportistaSelect.addEventListener('change', async function() {
        const transportistaId = this.value;
        if (!transportistaId) {
            transportistaInfo.innerHTML = '';
            conductorNombre.innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`/albaranes/api/transportista/${transportistaId}`);
            if (!response.ok) throw new Error('Error al cargar datos del transportista');
            const data = await response.json();
            
            transportistaInfo.innerHTML = `
                <p class="mb-0">CIF: ${data.documento_cif}</p>
                <p class="mb-0">${data.direccion}</p>
                <p class="mb-0">${data.codigo_postal}</p>
                <p class="mb-0">${data.provincia}</p>
                <p class="mb-0">Tel: ${data.telefono}</p>
                <p class="mb-0">Email: ${data.email}</p>
            `;

            actualizarConductor();
        } catch (error) {
            console.error('Error:', error);
            transportistaInfo.innerHTML = '<p class="text-danger mb-0">Error al cargar datos del transportista</p>';
            conductorNombre.innerHTML = '';
        }
    });

    // Validar porcentaje
    porcentajeInput.addEventListener('input', function() {
        const valor = parseFloat(this.value);
        if (valor < 0) this.value = 0;
        if (valor > 100) this.value = 100;
    });

    // Función para cargar las líneas de la ruta
    async function cargarLineasRuta(rutaId, albaranId, porcentajePactado) {
        // Guardar el porcentaje pactado globalmente
        porcentajePactadoGlobal = porcentajePactado;
        console.log(`DEBUG: Porcentaje pactado guardado globalmente: ${porcentajePactadoGlobal}`);
        
        try {
            const response = await fetch(`/albaranes/api/lineas_ruta/${rutaId}`);
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Error al cargar líneas de la ruta');
            }
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message);
            }
            
            const lineas = result.data;
            const tbody = document.getElementById('lineas-resumen');
            tbody.innerHTML = '';
            
            // No agregar línea automáticamente, solo mostrar tabla vacía
            if (lineas.length === 0) {
                // Solo mostrar la tabla vacía, sin agregar línea automáticamente
                console.log('No hay líneas existentes. Tabla lista para agregar líneas manualmente.');
            } else {
                let totalBeneficio = 0;
                let totalImpLiqu = 0;
                lineas.forEach(linea => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="text-end">${parseFloat(linea.beneficio).toFixed(2)} €</td>
                        <td class="text-end">${parseFloat(linea.imp_liqu).toFixed(2)} €</td>
                        <td class="text-end">${parseFloat(linea.porcentaje).toFixed(2)}%</td>
                        <td>${linea.conductor}</td>
                    `;
                    tbody.appendChild(tr);
                    totalBeneficio += parseFloat(linea.beneficio);
                    totalImpLiqu += parseFloat(linea.imp_liqu);
                });
                // Actualizar totales
                document.getElementById('total-beneficio').textContent = totalBeneficio.toFixed(2) + ' €';
                document.getElementById('total-imp-liqu').textContent = totalImpLiqu.toFixed(2) + ' €';
                document.getElementById('porcentaje-promedio').textContent = porcentajePactado + '%';
            }

            // Mostrar la tabla de líneas
            document.getElementById('lineas-albaran').style.display = 'block';
            // Mostrar la sección de líneas de albarán
            document.getElementById('lineas-form').style.display = 'block';
            // Deshabilitar solo algunos campos del formulario de cabecera
            // Mantener editables: serie_alb, numero_alb, ruta_id, transportista_id, porcentaje_pactado
            document.querySelectorAll('#cabecera-form select, #cabecera-form input').forEach(el => {
                const camposEditables = ['serie_alb', 'numero_alb', 'ruta_id', 'transportista_id', 'porcentaje_pactado'];
                if (!camposEditables.includes(el.name)) {
                    el.disabled = true;
                }
            });
            document.getElementById('btn-guardar').style.display = 'none';

            // Evento para el botón "Agregar Línea"
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'btn-agregar-linea') {
                    agregarNuevaLinea();
                }
            });

            // Configurar eventos para campos editables de la cabecera
            configurarEventosCabeceraEditables();

        } catch (error) {
            console.error('Error:', error);
            alert(error.message || 'Error al cargar las líneas de la ruta');
        }
    }

    // Modificar el manejador del formulario
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        try {
            const formData = new FormData(this);
            const response = await fetch('/albaranes/nuevo', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            if (!response.ok) throw new Error('Error en la respuesta del servidor');
            const result = await response.json();
            if (result.success) {
                // Cargar las líneas de la ruta
                cargarLineasRuta(result.ruta_id, result.albaran_id, result.porcentaje_pactado);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al guardar el albarán: ' + error.message);
        }
    });
});

// Cache para los resultados de la consulta SQL
let albaranesCache = new Map();

// Variable global para almacenar el porcentaje pactado
let porcentajePactadoGlobal = 0;

// Función para configurar eventos de campos editables de la cabecera
function configurarEventosCabeceraEditables() {
    // Campos editables de la cabecera
    const serieAlbInput = document.querySelector('input[name="serie_alb"]');
    const numeroAlbInput = document.querySelector('input[name="numero_alb"]');
    const rutaSelect = document.querySelector('select[name="ruta_id"]');
    const transportistaSelect = document.querySelector('select[name="transportista_id"]');
    const porcentajePactadoInput = document.querySelector('input[name="porcentaje_pactado"]');

    // Evento para buscar albarán cuando cambien serie o número
    function buscarAlbaranCabecera() {
        const serie = serieAlbInput.value.trim();
        const numero = numeroAlbInput.value.trim();
        
        if (serie && numero) {
            // Buscar el albarán y actualizar campos automáticamente
            buscarAlbaranAPI(serie, numero).then(data => {
                if (data.success) {
                    // Actualizar campos de solo lectura con los nuevos datos
                    actualizarCamposCabecera(data.data);
                    // Recalcular todos los campos derivados
                    recalcularTodosCampos();
                }
            }).catch(error => {
                console.error('Error al buscar albarán:', error);
            });
        }
    }

    // Función para actualizar campos de la cabecera con nuevos datos
    function actualizarCamposCabecera(data) {
        document.querySelector('input[name="nombre_cliente"]').value = data.nombre_cliente || '';
        document.querySelector('input[name="cod_cliente"]').value = data.cod_cliente || '';
        document.querySelector('input[name="municipio_envio"]').value = data.municipio_envio || '';
        document.querySelector('input[name="imp_liqu"]').value = formatearNumero(data.imp_liqu) || '';
        document.querySelector('input[name="fecha_alb"]').value = formatearFecha(data.fecha_alb) || '';
        document.querySelector('input[name="beneficio"]').value = formatearNumero(data.beneficio) || '';
        document.querySelector('input[name="porcentaje"]').value = formatearNumero(data.porcentaje) || '';
        document.querySelector('input[name="conductor"]').value = data.conductor || '';
        document.querySelector('input[name="importe"]').value = formatearNumero(data.importe) || '';
        document.querySelector('input[name="lineas"]').value = data.lineas || '';
        document.querySelector('input[name="deuda"]').value = formatearDeuda(data.deuda) || '';
    }

    // Eventos para los campos editables
    if (serieAlbInput) {
        serieAlbInput.addEventListener('change', buscarAlbaranCabecera);
        serieAlbInput.addEventListener('keydown', function(e) {
            if (e.key === 'Tab' || e.key === 'Enter') {
                e.preventDefault();
                numeroAlbInput.focus();
                numeroAlbInput.select();
            }
        });
    }

    if (numeroAlbInput) {
        numeroAlbInput.addEventListener('change', buscarAlbaranCabecera);
        numeroAlbInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                buscarAlbaranCabecera();
            }
        });
    }

    if (porcentajePactadoInput) {
        porcentajePactadoInput.addEventListener('input', function() {
            // Actualizar variable global
            porcentajePactadoGlobal = parseFloat(this.value) || 0;
            // Recalcular todos los campos derivados
            recalcularTodosCampos();
        });
    }

    if (rutaSelect) {
        rutaSelect.addEventListener('change', function() {
            // Aquí se podría agregar lógica adicional si es necesario
            console.log('Ruta cambiada a:', this.value);
        });
    }

    if (transportistaSelect) {
        transportistaSelect.addEventListener('change', function() {
            // Aquí se podría agregar lógica adicional si es necesario
            console.log('Transportista cambiado a:', this.value);
        });
    }
}

// Función para buscar albarán mediante API
async function buscarAlbaranAPI(serie, numero) {
    try {
        const cacheKey = `${serie}-${numero}`;
        let datos;

        if (albaranesCache.has(cacheKey)) {
            datos = albaranesCache.get(cacheKey);
        } else {
            const response = await fetch(`/albaranes/api/buscar_albaran/${serie}/${numero}`);
            if (!response.ok) {
                throw new Error('No se encontró el albarán');
            }
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message || 'Error al buscar el albarán');
            }
            datos = result.data;
            albaranesCache.set(cacheKey, datos);
        }

        return { success: true, data: datos };
    } catch (error) {
        console.error('Error al buscar albarán:', error);
        return { success: false, message: error.message };
    }
}

// Función para recalcular todos los campos derivados
function recalcularTodosCampos() {
    // Recalcular TLPA y otros campos derivados en la cabecera
    const importe = parseFloat(document.querySelector('input[name="importe"]').value) || 0;
    const porcentaje = porcentajePactadoGlobal || parseFloat(document.querySelector('input[name="porcentaje_pactado"]').value) || 0;
    const beneficio = parseFloat(document.querySelector('input[name="beneficio"]').value) || 0;
    
    if (importe > 0 && porcentaje > 0) {
        const tlpa = importe * (porcentaje / 100);
        const benPostLog = beneficio - tlpa;
        const porcentajeBenReal = (benPostLog / importe) * 100;
        
        // Actualizar campos calculados
        document.querySelector('input[name="tlpa"]').value = formatearNumero(tlpa);
        document.querySelector('input[name="ben_post_log"]').value = formatearNumero(benPostLog);
        document.querySelector('input[name="porcentaje_ben_real"]').value = formatearNumero(porcentajeBenReal);
    }
    
    // Recalcular totales de las líneas
    recalcularTotales();
}

// Mejorar la función agregarNuevaLinea para experiencia tipo Excel
function agregarNuevaLinea() {
    const template = document.getElementById('linea-template');
    const nuevaLinea = template.content.cloneNode(true);
    const tr = nuevaLinea.querySelector('tr');
    
    // Limpiar todos los campos
    tr.querySelectorAll('span').forEach(span => span.textContent = '');
    tr.querySelectorAll('input').forEach(input => {
        if (input.classList.contains('serie-alb') || input.classList.contains('numero-alb')) {
            input.value = '';
            input.readOnly = false;
            input.style.backgroundColor = '#ffffff';
            input.style.border = '2px solid #007bff';
        } else if (input.classList.contains('importe')) {
            input.value = '';
            input.readOnly = true;
            input.style.backgroundColor = '#f8f9fa';
        }
    });
    
    // Deshabilitar botones hasta que se complete la línea
    tr.querySelector('.btn-ok').disabled = true;
    tr.querySelector('.btn-mas').disabled = true;
    tr.querySelector('.edit-importe').style.display = 'none';
    
    // Agregar la línea al tbody
    document.getElementById('lineas-body').appendChild(nuevaLinea);
    
    // Configurar eventos para la nueva línea
    const ultimaLinea = document.querySelector('#lineas-body tr:last-child');
    configurarEventosLinea(ultimaLinea);
    
    // Enfocar el input de serie y añadir placeholder
    const serieInput = ultimaLinea.querySelector('.serie-alb');
    const numeroInput = ultimaLinea.querySelector('.numero-alb');
    
    serieInput.placeholder = 'Serie...';
    numeroInput.placeholder = 'Número...';
    
    setTimeout(() => {
        serieInput.focus();
        serieInput.select();
    }, 100);
    
    // Evento para pasar al siguiente campo con Tab o Enter
    serieInput.addEventListener('keydown', function(e) {
        if (e.key === 'Tab' || e.key === 'Enter') {
            e.preventDefault();
            numeroInput.focus();
            numeroInput.select();
        }
    });
}

// Función para configurar eventos de una línea (mejorada para experiencia Excel)
function configurarEventosLinea(lineaElement) {
    const serieInput = lineaElement.querySelector('.serie-alb');
    const numeroInput = lineaElement.querySelector('.numero-alb');
    const importeInput = lineaElement.querySelector('.importe');
    const editImporteBtn = lineaElement.querySelector('.edit-importe');
    const btnOk = lineaElement.querySelector('.btn-ok');
    const btnMas = lineaElement.querySelector('.btn-mas');
    const btnEliminar = lineaElement.querySelector('.btn-eliminar');

    // Función para verificar si la línea está completa
    function verificarLineaCompleta() {
        const serie = serieInput.value.trim();
        const numero = numeroInput.value.trim();
        const importe = importeInput.value.trim();
        
        if (serie && numero && importe) {
            btnOk.disabled = false;
            btnMas.disabled = false;
            editImporteBtn.style.display = 'inline-block';
            // Cambiar color de borde a verde para indicar completado
            serieInput.style.border = '2px solid #28a745';
            numeroInput.style.border = '2px solid #28a745';
        } else {
            btnOk.disabled = true;
            btnMas.disabled = true;
            editImporteBtn.style.display = 'none';
        }
    }

    // Evento para eliminar línea
    btnEliminar.addEventListener('click', () => {
        if (confirm('¿Está seguro de eliminar esta línea?')) {
            lineaElement.remove();
            // Recalcular totales después de eliminar
            recalcularTotales();
        }
    });

    // Evento para buscar albarán al presionar Enter en numero-alb
    numeroInput.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
            const serie = serieInput.value.trim();
            const numero = numeroInput.value.trim();
            
            if (serie && numero) {
                // Mostrar indicador de carga
                numeroInput.style.backgroundColor = '#fff3cd';
                numeroInput.value = 'Buscando...';
                numeroInput.disabled = true;
                
                try {
                    await buscarYRellenarDatos(serie, numero, lineaElement);
                    verificarLineaCompleta();
                } catch (error) {
                    // Restaurar estado si hay error
                    numeroInput.style.backgroundColor = '#ffffff';
                    numeroInput.value = numero;
                    numeroInput.disabled = false;
                    numeroInput.focus();
                }
            } else {
                // Enfocar el campo vacío sin alert
                if (!serie) {
                    serieInput.focus();
                    serieInput.style.border = '2px solid #dc3545';
                } else {
                    numeroInput.focus();
                    numeroInput.style.border = '2px solid #dc3545';
                }
            }
        }
    });

    // Eventos para validar completitud al cambiar valores
    serieInput.addEventListener('input', () => {
        verificarLineaCompleta();
        // Recalcular campos cuando cambie el importe
        if (importeInput.value) {
            recalcularCampos(lineaElement);
        }
    });
    
    numeroInput.addEventListener('input', () => {
        verificarLineaCompleta();
        // Recalcular campos cuando cambie el importe
        if (importeInput.value) {
            recalcularCampos(lineaElement);
        }
    });
    
    importeInput.addEventListener('input', () => {
        verificarLineaCompleta();
        // Recalcular campos automáticamente cuando cambie el importe
        recalcularCampos(lineaElement);
    });

    // Evento para el botón de editar importe
    editImporteBtn.addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('editImporteModal'));
        const importeActual = importeInput.value;
        document.getElementById('nuevoImporte').value = importeActual;
        
        // Configurar evento del botón confirmar
        document.getElementById('confirmarImporte').onclick = () => {
            const nuevoImporte = document.getElementById('nuevoImporte').value;
            if (nuevoImporte && nuevoImporte !== importeActual) {
                importeInput.value = nuevoImporte;
                recalcularCampos(lineaElement);
                verificarLineaCompleta();
            }
            modal.hide();
        };
        
        modal.show();
    });

    // Eventos para los botones OK y Más (corregidos)
    btnOk.addEventListener('click', (e) => {
        e.preventDefault();
        finalizarLinea(lineaElement, false);
    });
    
    btnMas.addEventListener('click', (e) => {
        e.preventDefault();
        finalizarLinea(lineaElement, true);
    });
}

// Función para buscar y rellenar datos (mejorada)
async function buscarYRellenarDatos(serie, numero, lineaElement) {
    const numeroInput = lineaElement.querySelector('.numero-alb');
    const serieInput = lineaElement.querySelector('.serie-alb');
    
    try {
        const cacheKey = `${serie}-${numero}`;
        let datos;

        if (albaranesCache.has(cacheKey)) {
            datos = albaranesCache.get(cacheKey);
        } else {
            const response = await fetch(`/albaranes/api/buscar_albaran/${serie}/${numero}`);
            if (!response.ok) {
                throw new Error('No se encontró el albarán');
            }
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message || 'Error al buscar el albarán');
            }
            datos = result.data;
            albaranesCache.set(cacheKey, datos);
        }

        // Restaurar el estado normal de los inputs
        numeroInput.style.backgroundColor = '#ffffff';
        numeroInput.value = numero;
        numeroInput.disabled = false;
        
        // Rellenar datos en la línea
        rellenarDatosLinea(lineaElement, datos);
        
        // Indicar éxito visualmente
        serieInput.style.backgroundColor = '#d4edda';
        numeroInput.style.backgroundColor = '#d4edda';
        
        setTimeout(() => {
            serieInput.style.backgroundColor = '#ffffff';
            numeroInput.style.backgroundColor = '#ffffff';
        }, 1000);
        
    } catch (error) {
        // Restaurar estado y mostrar error
        numeroInput.style.backgroundColor = '#f8d7da';
        numeroInput.value = numero;
        numeroInput.disabled = false;
        
        setTimeout(() => {
            numeroInput.style.backgroundColor = '#ffffff';
        }, 2000);
        
        alert(error.message);
        throw error; // Re-lanzar para que el llamador pueda manejarlo
    }
}

// Función auxiliar para formatear fecha a dd/mm/aaaa
function formatearFecha(fechaString) {
    if (!fechaString) return '';
    
    const fecha = new Date(fechaString);
    if (isNaN(fecha.getTime())) return fechaString;
    
    const dia = fecha.getDate().toString().padStart(2, '0');
    const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
    const año = fecha.getFullYear();
    return `${dia}/${mes}/${año}`;
}

// Función auxiliar para formatear números con 2 decimales
function formatearNumero(numero) {
    if (numero === null || numero === undefined || numero === '') return '0.00';
    return parseFloat(numero).toFixed(2);
}

// Función auxiliar para formatear deuda
function formatearDeuda(deuda) {
    if (!deuda || deuda === null) return '0.00€';
    if (typeof deuda === 'string' && deuda.includes('€')) return deuda;
    return formatearNumero(deuda) + '€';
}

// Función para rellenar datos en la línea
function rellenarDatosLinea(lineaElement, datos) {
    // Rellenar campos con los datos formateados
    lineaElement.querySelector('.fecha-alb').textContent = formatearFecha(datos.fecha_alb);
    lineaElement.querySelector('.nombre-cliente').textContent = datos.nombre_cliente || '';
    lineaElement.querySelector('.cod-cliente').textContent = datos.cod_cliente || '';
    lineaElement.querySelector('.municipio-envio').textContent = datos.municipio_envio || '';
    lineaElement.querySelector('.importe').value = formatearNumero(datos.importe);
    lineaElement.querySelector('.beneficio').textContent = formatearNumero(datos.beneficio);
    lineaElement.querySelector('.imp-liqu').textContent = formatearNumero(datos.imp_liqu);
    lineaElement.querySelector('.porcentaje').textContent = formatearNumero(datos.porcentaje);
    lineaElement.querySelector('.conductor').textContent = datos.conductor || '';
    lineaElement.querySelector('.deuda').textContent = formatearDeuda(datos.deuda);
    lineaElement.querySelector('.lineas').textContent = datos.lineas || '0';

    // Calcular campos derivados
    recalcularCampos(lineaElement);

    // Habilitar botones
    lineaElement.querySelector('.btn-ok').disabled = false;
    lineaElement.querySelector('.btn-mas').disabled = false;
}

// Función para recalcular campos (mejorada)
function recalcularCampos(lineaElement) {
    const importe = parseFloat(lineaElement.querySelector('.importe').value) || 0;
    
    // Intentar obtener el porcentaje pactado de diferentes fuentes
    let porcentajePactado = 0;
    const porcentajePactadoElement = document.getElementById('porcentaje_pactado');
    
    if (porcentajePactadoElement && porcentajePactadoElement.value) {
        porcentajePactado = parseFloat(porcentajePactadoElement.value) || 0;
    } else if (porcentajePactadoGlobal > 0) {
        // Usar la variable global como respaldo
        porcentajePactado = porcentajePactadoGlobal;
    } else {
        // Si el campo está deshabilitado, intentar obtenerlo del texto mostrado
        const porcentajePromedioElement = document.getElementById('porcentaje-promedio');
        if (porcentajePromedioElement && porcentajePromedioElement.textContent) {
            const textoPromedio = porcentajePromedioElement.textContent.replace('%', '');
            porcentajePactado = parseFloat(textoPromedio) || 0;
        }
    }
    
    console.log(`DEBUG TLPA: importe=${importe}, porcentajePactado=${porcentajePactado}, elemento encontrado=${!!porcentajePactadoElement}, valor del elemento=${porcentajePactadoElement ? porcentajePactadoElement.value : 'NO ENCONTRADO'}`);
    
    // Calcular TLPA
    const tlpa = importe * (porcentajePactado / 100);
    const tlpaElement = lineaElement.querySelector('.tlpa');
    console.log(`DEBUG TLPA: calculado=${tlpa}, elemento encontrado=${!!tlpaElement}`);
    if (tlpaElement) {
        tlpaElement.textContent = formatearNumero(tlpa);
        console.log(`DEBUG TLPA: valor asignado=${tlpaElement.textContent}`);
    }
    
    // Calcular Beneficio Post-Logístico
    const beneficioElement = lineaElement.querySelector('.beneficio');
    const beneficio = parseFloat(beneficioElement ? beneficioElement.textContent : 0) || 0;
    const benPostLog = beneficio - tlpa;
    const benPostLogElement = lineaElement.querySelector('.ben-post-log');
    if (benPostLogElement) {
        benPostLogElement.textContent = formatearNumero(benPostLog);
    }
    
    // Calcular Porcentaje Beneficio Real
    const porBenReal = importe !== 0 ? (benPostLog / importe) * 100 : 0;
    const porBenRealElement = lineaElement.querySelector('.por-ben-real');
    if (porBenRealElement) {
        porBenRealElement.textContent = formatearNumero(porBenReal);
    }
    
    // Recalcular totales de la cabecera
    recalcularTotales();
}

// Función para finalizar línea (corregida)
function finalizarLinea(lineaElement, agregarNueva) {
    // Verificar que la línea esté completa antes de finalizar
    const serie = lineaElement.querySelector('.serie-alb').value.trim();
    const numero = lineaElement.querySelector('.numero-alb').value.trim();
    const importe = lineaElement.querySelector('.importe').value.trim();
    
    if (!serie || !numero || !importe) {
        // Resaltar campos faltantes
        if (!serie) lineaElement.querySelector('.serie-alb').style.border = '2px solid #dc3545';
        if (!numero) lineaElement.querySelector('.numero-alb').style.border = '2px solid #dc3545';
        if (!importe) lineaElement.querySelector('.importe').style.border = '2px solid #dc3545';
        return;
    }
    
    // Marcar la línea como finalizada
    lineaElement.classList.add('linea-finalizada');
    
    // Hacer los inputs de solo lectura
    lineaElement.querySelectorAll('input').forEach(input => {
        input.readOnly = true;
        input.style.backgroundColor = '#f8f9fa';
        input.style.border = '1px solid #dee2e6';
    });
    
    // Deshabilitar botones de la línea
    lineaElement.querySelector('.btn-ok').disabled = true;
    lineaElement.querySelector('.btn-mas').disabled = true;
    lineaElement.querySelector('.edit-importe').style.display = 'none';
    
    // Actualizar totales de la cabecera
    recalcularTotales();
    
    // Agregar nueva línea si se solicitó
    if (agregarNueva) {
        setTimeout(() => {
            agregarNuevaLinea();
        }, 100);
    }
}

// Función para actualizar totales de la cabecera (mejorada)
function recalcularTotales() {
    let totalBeneficio = 0;
    let totalImpLiqu = 0;
    let totalTLPA = 0;
    let totalLineas = 0;
    
    // Recorrer todas las líneas que tienen datos
    document.querySelectorAll('#lineas-body tr.linea-albaran').forEach(linea => {
        const beneficioElement = linea.querySelector('.beneficio');
        const impLiquElement = linea.querySelector('.imp-liqu');
        const tlpaElement = linea.querySelector('.tlpa');
        
        if (beneficioElement && beneficioElement.textContent) {
            const beneficio = parseFloat(beneficioElement.textContent) || 0;
            totalBeneficio += beneficio;
        }
        
        if (impLiquElement && impLiquElement.textContent) {
            const impLiqu = parseFloat(impLiquElement.textContent) || 0;
            totalImpLiqu += impLiqu;
        }
        
        if (tlpaElement && tlpaElement.textContent) {
            const tlpa = parseFloat(tlpaElement.textContent) || 0;
            totalTLPA += tlpa;
        }
        
        // Contar líneas que tienen datos
        const serie = linea.querySelector('.serie-alb').value.trim();
        const numero = linea.querySelector('.numero-alb').value.trim();
        if (serie && numero) {
            totalLineas++;
        }
    });
    
    // Actualizar totales en la tabla de resumen con formato Excel
    const totalBeneficioElement = document.getElementById('total-beneficio');
    const totalImpLiquElement = document.getElementById('total-imp-liqu');
    const totalTLPAElement = document.getElementById('total-tlpa');
    
    if (totalBeneficioElement) {
        totalBeneficioElement.textContent = formatearNumero(totalBeneficio);
    }
    if (totalImpLiquElement) {
        totalImpLiquElement.textContent = formatearNumero(totalImpLiqu);
    }
    if (totalTLPAElement) {
        totalTLPAElement.textContent = formatearNumero(totalTLPA);
    }
    
    // Calcular porcentaje total
    const porcentajeTotalElement = document.getElementById('porcentaje-total');
    if (porcentajeTotalElement && totalImpLiqu > 0) {
        const porcentajeTotal = (totalBeneficio / totalImpLiqu) * 100;
        porcentajeTotalElement.textContent = formatearNumero(porcentajeTotal) + '%';
    }
    
    console.log(`Totales recalculados: Beneficio: ${totalBeneficio.toFixed(2)}€, Imp. Líquido: ${totalImpLiqu.toFixed(2)}€, TLPA: ${totalTLPA.toFixed(2)}€, Líneas: ${totalLineas}`);
}
</script>
{% endblock %}
